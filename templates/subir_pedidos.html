{% extends "base.html" %}
{% block title %}Subir Pedidos{% endblock %}

{% block content %}
<div class="max-w-md mx-auto bg-white p-6 rounded-3xl shadow-xl space-y-4">
  <h1 class="text-2xl font-bold text-center">ðŸšš Subir Pedidos</h1>
  <form id="cred-form" class="space-y-4" autocomplete="off">
    <div>
      <label class="block mb-1 font-medium">Usuario</label>
      <input name="usuario" id="usuario" type="text" required autocomplete="username"
             class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" />
    </div>
    <div>
      <label class="block mb-1 font-medium">ContraseÃ±a</label>
      <input name="contrasena" id="contrasena" type="password" required autocomplete="new-password"
             class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" />
    </div>
  </form>
</div>

<div class="max-w-4xl mx-auto mt-8">
  <div class="flex justify-between items-center mb-2">
    <h2 class="text-xl font-bold">VehÃ­culos</h2>
    <button id="btn-add" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Agregar ruta</button>
  </div>
  <table class="min-w-full bg-white shadow rounded-lg">
    <thead>
      <tr class="bg-gray-200 text-left">
        <th class="p-2">Ruta</th>
        <th class="p-2">Placa</th>
        <th class="p-2">Estado</th>
        <th class="p-2">Paso actual</th>
        <th class="p-2">AcciÃ³n</th>
      </tr>
    </thead>
    <tbody id="tabla-vehiculos">
    {% for v in vehiculos %}
      <tr data-ruta="{{ v.ruta }}" class="border-t">
        <td class="p-2">{{ v.ruta }}</td>
        <td class="p-2"><input type="text" maxlength="10" value="{{ v.placa }}" class="placa-input w-full border rounded p-1"/></td>
        <td class="p-2 estado">{{ v.estado }}</td>
        <td class="p-2 paso">{{ v.paso or '' }}</td>
        <td class="p-2">
          <button class="play-btn px-3 py-1 bg-green-600 text-white rounded" {% if v.estado in ['ejecutando','en cola'] %}disabled{% endif %}>Play</button>
          <button class="stop-btn px-3 py-1 bg-red-600 text-white rounded {% if v.estado not in ['ejecutando','en cola'] %}hidden{% endif %}">Stop</button>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>

<script>
const bd = "{{ bd }}";

function savePlaca(ruta, placa){
  fetch("/vehiculos/placa", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({bd: bd, ruta: ruta, placa: placa})
  });
}

function attachRowEvents(tr){
  const inp = tr.querySelector('.placa-input');
  inp.addEventListener('blur', function(){
    savePlaca(parseInt(tr.dataset.ruta), this.value);
  });
  inp.addEventListener('keypress', function(e){
    if(e.key === 'Enter'){ e.preventDefault(); this.blur(); }
  });
  tr.querySelector('.play-btn').addEventListener('click', function(){
    const usuario = document.getElementById('usuario').value;
    const contrasena = document.getElementById('contrasena').value;
    fetch('/vehiculos/play', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({bd: bd, ruta: parseInt(tr.dataset.ruta), usuario: usuario, contrasena: contrasena})
    }).then(r=>r.json()).then(res=>{
      if(res.success){
        updateRow(tr, res.data.status, '', '');
      } else {
        updateRow(tr, 'error', '', '');
      }
    });
  });

  tr.querySelector('.stop-btn').addEventListener('click', function(){
    fetch('/vehiculos/stop', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({bd: bd, ruta: parseInt(tr.dataset.ruta)})
    }).then(r=>r.json()).then(res=>{
      if(res.success){
        updateRow(tr, res.data.status, tr.querySelector('.paso').textContent, '');
      }
    });
  });
}

function updateRow(tr, estado, paso, message){
  tr.querySelector('.estado').textContent = estado;
  tr.querySelector('.paso').textContent = paso || '';
  const play = tr.querySelector('.play-btn');
  const stop = tr.querySelector('.stop-btn');
  if(['ejecutando','en cola'].includes(estado)){
    play.disabled = true;
    stop.classList.remove('hidden');
  } else {
    play.disabled = false;
    stop.classList.add('hidden');
  }
  if(estado === 'error' && message){
    tr.querySelector('.estado').title = message;
  } else {
    tr.querySelector('.estado').removeAttribute('title');
  }
}

document.querySelectorAll('#tabla-vehiculos tr').forEach(tr => {
  attachRowEvents(tr);
  updateRow(tr, tr.querySelector('.estado').textContent.trim(), tr.querySelector('.paso').textContent.trim(), '');
});

document.getElementById('btn-add').addEventListener('click', function(){
  fetch('/vehiculos/add', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({bd: bd})
  }).then(r=>r.json()).then(res=>{
    if(res.success){
      const v = res.data;
      const tr = document.createElement('tr');
      tr.setAttribute('data-ruta', v.ruta);
      tr.classList.add('border-t');
      tr.innerHTML = `<td class="p-2">${v.ruta}</td>
        <td class="p-2"><input type="text" maxlength="10" value="" class="placa-input w-full border rounded p-1"/></td>
        <td class="p-2 estado">pendiente</td>
        <td class="p-2 paso"></td>
        <td class="p-2"><button class="play-btn px-3 py-1 bg-green-600 text-white rounded">Play</button>
            <button class="stop-btn px-3 py-1 bg-red-600 text-white rounded hidden">Stop</button></td>`;
      document.getElementById('tabla-vehiculos').appendChild(tr);
      attachRowEvents(tr);
      updateRow(tr, 'pendiente', '', '');
    }
  });
});

function poll(){
  document.querySelectorAll('#tabla-vehiculos tr').forEach(tr => {
    const ruta = tr.dataset.ruta;
    fetch(`/vehiculos/estado?bd=${encodeURIComponent(bd)}&ruta=${ruta}`)
      .then(r=>r.json()).then(res=>{
        if(res.success){
          updateRow(tr, res.data.status, res.data.paso, res.data.message);
        }
      });
  });
}
setInterval(poll, 2500);
</script>
{% endblock %}
