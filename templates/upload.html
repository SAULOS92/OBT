{% extends "base.html" %}
{% block title %}Cargar Pedidos & Rutas{% endblock %}

{% block content %}
<div class="relative">

  <!-- Spinner -->
  <div id="loading-overlay" class="hidden absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
    <svg class="h-12 w-12 animate-spin text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor"
            d="M4 12a8 8 0 018-8v4l3-3-3-3v4a8 8 0 100 16v-4l-3 3 3 3v-4a8 8 0 01-8-8z">
      </path>
    </svg>
  </div>

  <!-- Contenedor principal -->
  <div class="max-w-lg mx-auto bg-white p-8 rounded-3xl shadow-xl space-y-6">

    <!-- Título -->
    <h1 class="text-3xl font-extrabold text-center">📤 Cargar Pedidos & Rutas</h1>

    <!-- Instrucciones -->
    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 space-y-3 rounded-lg">
      <h2 class="font-semibold text-blue-700">📥 Cargar aquí los archivos:</h2>
      <div>
        <h3 class="flex items-center text-lg font-medium">
          <span class="mr-2 text-green-600">✅</span>
          <span class="underline">ECOM</span>
        </h3>
        <ol class="list-decimal list-inside text-gray-700 space-y-1 ml-6">
          <li>Comercial → Pedidos → Todos los pedidos en estado «Sin Descargar»</li>
          <li>Despachos → ClixRuta</li>
        </ol>
      </div>
      <div>
        <h3 class="flex items-center text-lg font-medium">
          <span class="mr-2 text-purple-600">📦</span>
          <span class="underline">CELUWEB</span>
        </h3>
        <ol class="list-decimal list-inside text-gray-700 space-y-1 ml-6">
          <li>Pedidos</li>
          <li>Logística → Facturación → Administración de Rutas → Asignación de Rutas → Exportar Rutas Asignadas</li>
        </ol>
      </div>
      <p class="mt-2 text-red-600 font-semibold">
        ⚠️ <span class="font-medium">IMPORTANTE:</span> Antes de generar los pedidos, todos los clientes deben tener una ruta asignada.
      </p>
    </div>

    <!-- Flash messages -->
    <div id="flash-messages" class="space-y-2">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for cat, msg in messages %}
            <div class="px-4 py-2 rounded-lg {% if cat=='success' %}bg-green-100 text-green-700{% else %}bg-red-100 text-red-700{% endif %}">
              {{ msg }}
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
    </div>

    <!-- Formulario de carga -->
    <form id="upload-form" class="space-y-4">
      <div>
        <label class="block mb-1 font-medium">📄 Excel Pedidos</label>
        <input type="file" id="file-pedidos" accept=".xlsx" required
               class="block w-full text-sm text-gray-600 file:py-2 file:px-4 file:border-0 file:rounded-xl file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
      </div>
      <div>
        <label class="block mb-1 font-medium">🚚 Excel Rutas</label>
        <input type="file" id="file-rutas" accept=".xlsx" required
               class="block w-full text-sm text-gray-600 file:py-2 file:px-4 file:border-0 file:rounded-xl file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
      </div>
      <div>
        <label class="block mb-1 font-medium">📆 Día de la semana</label>
        <select id="select-dia" required
                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
          <option value="" disabled selected>Selecciona un día</option>
          <option value="LU">Lunes (LU)</option>
          <option value="MA">Martes (MA)</option>
          <option value="MI">Miércoles (MI)</option>
          <option value="JU">Jueves (JU)</option>
          <option value="VI">Viernes (VI)</option>
          <option value="SA">Sábado (SA)</option>
          <option value="DO">Domingo (DO)</option>
        </select>
      </div>
      <button id="submit-btn" type="submit"
              class="w-full py-3 font-semibold rounded-xl bg-blue-600 text-white hover:bg-blue-700 transition" disabled>
        Cargar Masivo
      </button>
    </form>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const fPed    = document.getElementById('file-pedidos');
  const fRut    = document.getElementById('file-rutas');
  const selDia  = document.getElementById('select-dia');
  const btn     = document.getElementById('submit-btn');
  const overlay = document.getElementById('loading-overlay');
  const flash   = document.getElementById('flash-messages');
  const form    = document.getElementById('upload-form');

  const PED_HEADERS = [
    "numero_pedido","cliente","nombre","barrio","ciudad",
    "asesor","codigo_pro","producto","cantidad","valor",
    "tipo_pro","estado"
  ];
  const RUT_HEADERS = ["codigo_cliente","codigo_ruta"];
  const DIAS_VALIDOS = ["LU","MA","MI","JU","VI","SA","DO"];

  const PED_COL_MAP = {
    'pedido':'numero_pedido','cliente':'cliente','código cliente':'cliente',
    'r. social':'nombre','razón social':'nombre','barrio':'barrio','ciudad':'ciudad',
    'asesor':'asesor','código vendedor':'asesor','cod.prod':'codigo_pro',
    'código producto':'codigo_pro','producto':'producto','cantidad':'cantidad',
    'valor':'valor','total':'valor','venta neta iva':'valor',
    'tip pro':'tipo_pro','tipo_prod':'tipo_pro','estado':'estado','est':'estado'
  };
  const RUT_COL_MAP = {
    'cod. cliente':'codigo_cliente','código cw':'codigo_cliente',
    'ruta':'codigo_ruta','descripción ruta':'codigo_ruta'
  };

  let bufferPed, bufferRut;

  function showMsg(type, msgs) {
    flash.innerHTML = '';
    const div = document.createElement('div');
    div.className = 'px-4 py-2 rounded-lg ' +
      (type==='success'? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700');
    if (Array.isArray(msgs)) {
      const ul = document.createElement('ul');
      msgs.forEach(m=>{ const li = document.createElement('li'); li.textContent = m; ul.appendChild(li); });
      div.appendChild(ul);
    } else {
      div.textContent = msgs;
    }
    flash.appendChild(div);
  }

  async function leerBuffer(file) {
    return file.arrayBuffer();
  }

  async function leerEnc(buffer) {
    const wb = XLSX.read(buffer, { type:'array', sheetRows:1 });
    const sh = wb.Sheets[wb.SheetNames[0]];
    const [row] = XLSX.utils.sheet_to_json(sh, { header:1, defval:null });
    return row.map(h=>h?.toString().trim().toLowerCase()||'');
  }

  function validarHeaders(raw, map, expected) {
    const dup = [], falt = [], norm = [];
    raw.forEach(h => {
      const k = map[h] || h;
      const count = norm.filter(x=>x===k).length;
      if (count) dup.push(k);
      norm.push(k);
    });
    expected.forEach(e => { if (!norm.includes(e)) falt.push(e); });
    return { norm, dup: [...new Set(dup)], falt };
  }

  async function validarEncabezados() {
    flash.innerHTML = '';
    btn.disabled = true;

    if (!fPed.files[0] || !fRut.files[0]) return;

    bufferPed = await leerBuffer(fPed.files[0]);
    bufferRut = await leerBuffer(fRut.files[0]);

    const rawPed = await leerEnc(bufferPed);
    const rawRut = await leerEnc(bufferRut);

    const vPed = validarHeaders(rawPed, PED_COL_MAP, PED_HEADERS);
    const vRut = validarHeaders(rawRut, RUT_COL_MAP, RUT_HEADERS);

    const msgs = [];
    if (vPed.dup.length) msgs.push('Duplicadas en pedidos: ' + vPed.dup.join(', '));
    if (vPed.falt.length) msgs.push('Faltan en pedidos: ' + vPed.falt.join(', '));
    if (vRut.dup.length) msgs.push('Duplicadas en rutas: ' + vRut.dup.join(', '));
    if (vRut.falt.length) msgs.push('Faltan en rutas: ' + vRut.falt.join(', '));

    if (msgs.length) {
      showMsg('error', msgs);
    } else {
      showMsg('success', 'Encabezados válidos');
      btn.disabled = false;
    }
  }

  fPed.addEventListener('change', validarEncabezados);
  fRut.addEventListener('change', validarEncabezados);

  form.addEventListener('submit', async e => {
    e.preventDefault();
    flash.innerHTML = '';
    overlay.classList.remove('hidden');
    btn.disabled = true;

    const dia = selDia.value;
    const errs = [];
    if (!DIAS_VALIDOS.includes(dia)) errs.push('Día inválido.');

    if (errs.length) {
      showMsg('error', errs);
      overlay.classList.add('hidden');
      btn.disabled = false;
      return;
    }

    try {
      // Leer datos completos reutilizando buffers
      const datosPed = await (async () => {
        const wb = XLSX.read(bufferPed, { type:'array' });
        const sh = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sh, { header:1, defval:null });
        const raw = rows[0].map(h=>h?.toString().trim().toLowerCase()||'');
        const norm = raw.map(h=>PED_COL_MAP[h]||h);
        if (!norm.includes('tipo_pro')) norm.push('tipo_pro');
        return rows.slice(1).map(vals => {
          const o = {};
          norm.forEach((hdr,i) => {
            if (PED_HEADERS.includes(hdr)) {
              o[hdr] = (hdr==='tipo_pro' && raw.indexOf('tipo_pro')===-1)
                       ? 'N'
                       : vals[i];
            }
          });
          return o;
        });
      })();

      const datosRut = await (async () => {
        const wb = XLSX.read(bufferRut, { type:'array' });
        const sh = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sh, { header:1, defval:null });
        const raw = rows[0].map(h=>h?.toString().trim().toLowerCase()||'');
        const norm = raw.map(h=>RUT_COL_MAP[h]||h);
        return rows.slice(1).map(vals => {
          const o = {};
          norm.forEach((hdr,i) => {
            if (RUT_HEADERS.includes(hdr)) {
              o[hdr] = vals[i];
            }
          });
          return o;
        });
      })();

      const res = await fetch(`/cargar-pedidos?dia=${encodeURIComponent(dia)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pedidos: datosPed, rutas: datosRut })
      });
      if (!res.ok) {
        const err = await res.json().catch(() => ({ error: `Error ${res.status}` }));
        throw new Error(err.error);
      }

      const blob = await res.blob();
      const cd   = res.headers.get('Content-Disposition');
      const fn   = cd?.match(/filename="(.+)"/)?.[1] || `Resumen_${Date.now()}.xlsx`;
      const a    = document.createElement('a');
      a.href     = URL.createObjectURL(blob);
      a.download = fn;
      document.body.appendChild(a);
      a.click();
      a.remove();

      showMsg('success', 'Descarga iniciada correctamente.');
      form.reset();
    } catch (err) {
      showMsg('error', err.message);
    } finally {
      overlay.classList.add('hidden');
      btn.disabled = false;
    }
  });
});
</script>
{% endblock %}











