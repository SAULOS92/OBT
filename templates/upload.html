{% extends "base.html" %}
{% block title %}Cargar Pedidos & Rutas{% endblock %}

{% block content %}
<div class="relative">
  <div id="loading-overlay" class="hidden absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
    <!-- spinner... -->
  </div>

  <div class="max-w-lg mx-auto bg-white p-8 rounded-3xl shadow-xl space-y-6">
    <h1 class="text-3xl font-extrabold text-center">游닋 Cargar Pedidos & Rutas</h1>

    <!-- instrucciones... -->

    <div id="flash-messages" class="space-y-2"></div>

    <form id="upload-form" class="space-y-4">
      <div>
        <label class="block mb-1 font-medium">游늯 Excel Pedidos</label>
        <input type="file" id="file-pedidos" accept=".xlsx" required
               class="block w-full text-sm text-gray-600 file:py-2 file:px-4 file:border-0 file:rounded-xl file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
      </div>
      <div>
        <label class="block mb-1 font-medium">游뚴 Excel Rutas</label>
        <input type="file" id="file-rutas" accept=".xlsx" required
               class="block w-full text-sm text-gray-600 file:py-2 file:px-4 file:border-0 file:rounded-xl file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
      </div>
      <div>
        <label class="block mb-1 font-medium">游늱 D칤a de la semana</label>
        <select id="select-dia" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
          <option value="" disabled selected>Selecciona un d칤a</option>
          <option value="LU">Lunes (LU)</option>
          <option value="MA">Martes (MA)</option>
          <option value="MI">Mi칠rcoles (MI)</option>
          <option value="JU">Jueves (JU)</option>
          <option value="VI">Viernes (VI)</option>
          <option value="SA">S치bado (SA)</option>
          <option value="DO">Domingo (DO)</option>
        </select>
      </div>
      <button id="submit-btn" type="submit"
              class="w-full py-3 font-semibold rounded-xl bg-blue-600 text-white hover:bg-blue-700 transition">
        Cargar Masivo
      </button>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('upload-form'),
        overlay = document.getElementById('loading-overlay'),
        flashContainer = document.getElementById('flash-messages'),
        submitBtn = document.getElementById('submit-btn'),
        filePed = document.getElementById('file-pedidos'),
        fileRut = document.getElementById('file-rutas'),
        selectDia = document.getElementById('select-dia');

  const PED_HEADERS = ['numero_pedido','cliente','nombre','barrio','ciudad','asesor','codigo_pro','producto','cantidad','valor','estado'];
  const RUT_HEADERS = ['codigo_cliente','codigo_ruta'];
  const DIAS_VALIDOS = ['LU','MA','MI','JU','VI','SA','DO'];
  const PED_COL_MAP = { /* ... tu mapa ... */ };
  const RUT_COL_MAP = { /* ... tu mapa ... */ };

  function mostrarMensaje(tipo, msgs) {
    flashContainer.innerHTML = '';
    const d = document.createElement('div');
    d.className = 'px-4 py-2 rounded-lg ' + (tipo==='success'?'bg-green-100 text-green-700':'bg-red-100 text-red-700');
    if (Array.isArray(msgs)) {
      const ul = document.createElement('ul');
      msgs.forEach(m=>{ const li = document.createElement('li'); li.textContent=m; ul.appendChild(li); });
      d.appendChild(ul);
    } else d.textContent = msgs;
    flashContainer.appendChild(d);
  }

  async function leerEncabezados(file) {
    const buf = await file.arrayBuffer(),
          wb  = XLSX.read(buf,{type:'array'}),
          sheet = wb.Sheets[wb.SheetNames[0]],
          [row] = XLSX.utils.sheet_to_json(sheet,{header:1,range:0,defval:null});
    return row.map(h=> h?.toString().trim().toLowerCase()||'');
  }

  async function leerDatosFiltrados(file, encOrig, normKeys, allowedKeys) {
    const buf = await file.arrayBuffer(),
          wb  = XLSX.read(buf,{type:'array'}),
          sheet = wb.Sheets[wb.SheetNames[0]],
          rows = XLSX.utils.sheet_to_json(sheet,{header:1,range:1,defval:null});
    return rows.map(vals => {
      const obj = {};
      encOrig.forEach((orig, i) => {
        const key = normKeys[i];
        if (allowedKeys.includes(key)) {
          obj[key] = vals[i];
        }
      });
      return obj;
    });
  }

  form.addEventListener('submit', async e => {
    e.preventDefault();
    flashContainer.innerHTML = '';
    overlay.classList.remove('hidden');
    submitBtn.disabled = true;

    const fPed = filePed.files[0], fRut = fileRut.files[0], dia = selectDia.value;
    let errs = [];
    if (!fPed||!fRut) errs.push('Selecciona ambos archivos.');
    else {
      const isX = f=>/\.(xlsx|xls)$/i.test(f.name);
      if (!isX(fPed)) errs.push('Excel Pedidos inv치lido.');
      if (!isX(fRut)) errs.push('Excel Rutas inv치lido.');
    }
    if (!DIAS_VALIDOS.includes(dia)) errs.push('D칤a inv치lido.');
    if (errs.length) {
      mostrarMensaje('error', errs);
      overlay.classList.add('hidden');
      submitBtn.disabled = false;
      return;
    }

    try {
      const origPed = await leerEncabezados(fPed),
            origRut = await leerEncabezados(fRut),
            normPed = origPed.map(h=>PED_COL_MAP[h]||h),
            normRut = origRut.map(h=>RUT_COL_MAP[h]||h);

      errs = [];
      PED_HEADERS.forEach(r=>{ if(!normPed.includes(r)) errs.push(`Falta pedidos: ${r}`); });
      RUT_HEADERS.forEach(r=>{ if(!normRut.includes(r)) errs.push(`Falta rutas: ${r}`); });
      if (errs.length) throw new Error(errs.join('; '));

      const datosPed = await leerDatosFiltrados(fPed, origPed, normPed, PED_HEADERS),
            datosRut = await leerDatosFiltrados(fRut, origRut, normRut, RUT_HEADERS);

      const res = await fetch(`/cargar-pedidos?dia=${encodeURIComponent(dia)}`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({pedidos:datosPed, rutas:datosRut})
      });

      if (!res.ok) {
        const err = await res.json().catch(_=>({error:`Error ${res.status}`}));
        throw new Error(err.error);
      }

      const blob = await res.blob(),
            cd   = res.headers.get('Content-Disposition'),
            fn   = cd?.match(/filename="(.+)"/)?.[1] || `ResumenPedidos_${Date.now()}.xlsx`,
            a    = document.createElement('a');

      a.href = URL.createObjectURL(blob);
      a.download = fn;
      document.body.appendChild(a);
      a.click();
      a.remove();

      mostrarMensaje('success','Descarga iniciada.');
      form.reset();
    } catch(err) {
      mostrarMensaje('error', err.message);
    } finally {
      overlay.classList.add('hidden');
      submitBtn.disabled = false;
    }
  });
});
</script>
{% endblock %}









