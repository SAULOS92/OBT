{% extends "base.html" %}
{% block title %}Cargar Pedidos & Rutas{% endblock %}

{% block content %}
<div class="relative">

  <!-- Spinner -->
  <div id="loading-overlay" class="hidden absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
    <svg class="h-12 w-12 animate-spin text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor"
            d="M4 12a8 8 0 018-8v4l3-3-3-3v4a8 8 0 100 16v-4l-3 3 3 3v-4a8 8 0 01-8-8z"/>
    </svg>
  </div>

  <div class="max-w-lg mx-auto bg-white p-8 rounded-3xl shadow-xl space-y-6">
    <h1 class="text-3xl font-extrabold text-center">ğŸ“¤ Cargar Pedidos & Rutas</h1>

    <!-- instrucciones -->
    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 space-y-3 rounded-lg">
      <h2 class="font-semibold text-blue-700">ğŸ“¥ Cargar aquÃ­ los archivos:</h2>
      <div>
        <h3 class="flex items-center text-lg font-medium">
          <span class="mr-2 text-green-600">âœ…</span>
          <span class="underline">ECOM</span>
        </h3>
        <ol class="list-decimal list-inside text-gray-700 ml-6">
          <li>Comercial â†’ Pedidos â†’ Todos los pedidos en estado Â«Sin DescargarÂ»</li>
          <li>Despachos â†’ ClixRuta</li>
        </ol>
      </div>
      <div>
        <h3 class="flex items-center text-lg font-medium">
          <span class="mr-2 text-purple-600">ğŸ“¦</span>
          <span class="underline">CELUWEB</span>
        </h3>
        <ol class="list-decimal list-inside text-gray-700 ml-6">
          <li>Pedidos</li>
          <li>LogÃ­stica â†’ FacturaciÃ³n â†’ AdministraciÃ³n de Rutas â†’ AsignaciÃ³n de Rutas â†’ Exportar Rutas Asignadas</li>
        </ol>
      </div>
      <p class="text-red-600 font-semibold">
        âš ï¸ <span class="font-medium">IMPORTANTE:</span> Antes de generar los pedidos, todos los clientes deben tener una ruta asignada.
      </p>
    </div>

    <div id="flash-messages" class="space-y-2"></div>

    <form id="upload-form" class="space-y-4">
      <div>
        <label class="block mb-1 font-medium">ğŸ“„ Excel Pedidos</label>
        <input type="file" id="file-pedidos" accept=".xlsx" required
               class="block w-full text-sm text-gray-600
                      file:py-2 file:px-4 file:border-0 file:rounded-xl
                      file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
      </div>
      <div>
        <label class="block mb-1 font-medium">ğŸšš Excel Rutas</label>
        <input type="file" id="file-rutas" accept=".xlsx" required
               class="block w-full text-sm text-gray-600
                      file:py-2 file:px-4 file:border-0 file:rounded-xl
                      file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
      </div>
      <div>
        <label class="block mb-1 font-medium">ğŸ“† DÃ­a de la semana</label>
        <select id="select-dia" required
                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
          <option value="" disabled selected>Selecciona un dÃ­a</option>
          <option value="LU">Lunes (LU)</option>
          <option value="MA">Martes (MA)</option>
          <option value="MI">MiÃ©rcoles (MI)</option>
          <option value="JU">Jueves (JU)</option>
          <option value="VI">Viernes (VI)</option>
          <option value="SA">SÃ¡bado (SA)</option>
          <option value="DO">Domingo (DO)</option>
        </select>
      </div>
      <button id="submit-btn" type="submit"
              class="w-full py-3 font-semibold rounded-xl bg-blue-600 text-white hover:bg-blue-700 transition"
              disabled>
        Cargar Masivo
      </button>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const fPed    = document.getElementById('file-pedidos');
  const fRut    = document.getElementById('file-rutas');
  const selDia  = document.getElementById('select-dia');
  const btn     = document.getElementById('submit-btn');
  const overlay = document.getElementById('loading-overlay');
  const flash   = document.getElementById('flash-messages');
  const form    = document.getElementById('upload-form');

  const PED_HEADERS = ["numero_pedido","cliente","nombre","barrio","ciudad","asesor","codigo_pro","producto","cantidad","valor","tipo_pro","estado"];
  const RUT_HEADERS = ["codigo_cliente","codigo_ruta"];
  const DIAS_VALIDOS = ["LU","MA","MI","JU","VI","SA","DO"];

  const PED_COL_MAP = {
    'pedido':'numero_pedido','cliente':'cliente','cÃ³digo cliente':'cliente',
    'r. social':'nombre','razÃ³n social':'nombre','barrio':'barrio','ciudad':'ciudad',
    'asesor':'asesor','cÃ³digo vendedor':'asesor','cod.prod':'codigo_pro',
    'cÃ³digo producto':'codigo_pro','producto':'producto','cantidad':'cantidad',
    'valor':'valor','total':'valor','venta neta iva':'valor',
    'tip pro':'tipo_pro','tipo_prod':'tipo_pro','estado':'estado','est':'estado'
  };
  const RUT_COL_MAP = {
    'cod. cliente':'codigo_cliente','cÃ³digo cw':'codigo_cliente',
    'ruta':'codigo_ruta','descripciÃ³n ruta':'codigo_ruta'
  };

  let bufferPed, bufferRut;

  function showMsg(type, msgs) {
    flash.innerHTML = '';
    const div = document.createElement('div');
    div.className = 'px-4 py-2 rounded-lg ' +
      (type==='success'? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700');
    if (Array.isArray(msgs)) {
      const ul = document.createElement('ul');
      msgs.forEach(m => { const li = document.createElement('li'); li.textContent = m; ul.appendChild(li); });
      div.appendChild(ul);
    } else {
      div.textContent = msgs;
    }
    flash.appendChild(div);
  }

  // lee ArrayBuffer una sola vez
  async function readBuffer(file) {
    return file.arrayBuffer();
  }

  // lee solo primera fila para validar
  async function readHeaders(buffer) {
    const wb = XLSX.read(buffer, { type:'array', sheetRows:1 });
    const sh = wb.Sheets[wb.SheetNames[0]];
    const [row] = XLSX.utils.sheet_to_json(sh, { header:1, defval:null });
    return row.map(h => h?.toString().trim().toLowerCase() || '');
  }

  // valida reactivo faltantes y duplicados
  function validateHeaders(raw, map, expected) {
    const norm = [], dup = [], falt = [];
    raw.forEach(h => {
      const k = map[h] || h;
      if (norm.includes(k)) dup.push(k);
      norm.push(k);
    });
    expected.forEach(e => { if (!norm.includes(e)) falt.push(e); });
    return { norm, dup:[...new Set(dup)], falt };
  }

  // validaciÃ³n reactiva al cambiar archivo
  async function reactiveValidate() {
    flash.innerHTML = '';
    btn.disabled = true;
    if (!fPed.files[0] || !fRut.files[0]) return;

    bufferPed = await readBuffer(fPed.files[0]);
    bufferRut = await readBuffer(fRut.files[0]);

    const rawPed = await readHeaders(bufferPed);
    const rawRut = await readHeaders(bufferRut);

    // Normalize headers
  let normPed = rawPed.map(h => PED_COL_MAP[h] || h);
  let normRut = rawRut.map(h => RUT_COL_MAP[h] || h);

  // **1. Inyectar 'tipo_pro' si falta**
  if (!normPed.includes('tipo_pro')) {
    normPed.push('tipo_pro');
  }

  // ValidaciÃ³n de duplicados y faltantes
  const vPed = validateHeaders(normPed, (h=>h), PED_HEADERS);
const vRut = validateHeaders(normRut, (h=>h), RUT_HEADERS);

    const errors = [];
    if (vPed.dup.length) errors.push('Duplicadas en pedidos: ' + vPed.dup.join(', '));
    if (vPed.falt.length) errors.push('Faltan en pedidos: ' + vPed.falt.join(', '));
    if (vRut.dup.length) errors.push('Duplicadas en rutas: ' + vRut.dup.join(', '));
    if (vRut.falt.length) errors.push('Faltan en rutas: ' + vRut.falt.join(', '));

    if (errors.length) showMsg('error', errors);
    else { showMsg('success','Encabezados vÃ¡lidos'); btn.disabled = false; }
  }

  fPed.addEventListener('change', reactiveValidate);
  fRut.addEventListener('change', reactiveValidate);

  // al enviar, procesa todo con forward/back fill y default tipo_pro
  form.addEventListener('submit', async e => {
    e.preventDefault();
    flash.innerHTML = '';
    overlay.classList.remove('hidden');
    btn.disabled = true;

    const dia = selDia.value;
    const errs = [];
    if (!DIAS_VALIDOS.includes(dia)) errs.push('DÃ­a invÃ¡lido.');
    if (errs.length) {
      showMsg('error', errs);
      overlay.classList.add('hidden');
      btn.disabled = false;
      return;
    }

    try {
      // pedidos: parsea todo, agrega tipo_pro=N si faltÃ³, luego forward/back fill
      const datosPed = await (async () => {
        const wb = XLSX.read(bufferPed, { type:'array' });
        const sh = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sh, { header:1, defval:null });
        const raw = rows[0].map(h=>h?.toString().trim().toLowerCase()||'');
        const norm = raw.map(h=>PED_COL_MAP[h]||h);
        if (!norm.includes('tipo_pro')) norm.push('tipo_pro');
        const data = rows.slice(1).map(vals => {
          const o = {};
          norm.forEach((hdr,i) => {
            if (PED_HEADERS.includes(hdr)) {
              o[hdr] = (hdr==='tipo_pro' && raw.indexOf('tipo_pro')<0) ? 'N' : vals[i];
            }
          });
          return o;
        });
        // forward/back fill por cliente
        const grupos = {};
        data.forEach((r,i) => (grupos[r.cliente]=grupos[r.cliente]||[]).push({i,r}));
        Object.values(grupos).forEach(arr => {
          arr.sort((a,b)=>a.i-b.i);
          let nom,bar,ciu;
          arr.forEach(x=>{const f=x.r; if(f.nombre) nom=f.nombre; else f.nombre=nom; if(f.barrio) bar=f.barrio; else f.barrio=bar; if(f.ciudad) ciu=f.ciudad; else f.ciudad=ciu;});
          let nom2,bar2,ciu2;
          arr.slice().reverse().forEach(x=>{const f=x.r; if(f.nombre) nom2=f.nombre; else f.nombre=nom2; if(f.barrio) bar2=f.barrio; else f.barrio=bar2; if(f.ciudad) ciu2=f.ciudad; else f.ciudad=ciu2;});
        });
        return data;
      })();

      // rutas: parsea todo
      const datosRut = await (async() => {
        const wb = XLSX.read(bufferRut, { type:'array' });
        const sh = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sh, { header:1, defval:null });
        const raw = rows[0].map(h=>h?.toString().trim().toLowerCase()||'');
        const norm = raw.map(h=>RUT_COL_MAP[h]||h);
        return rows.slice(1).map(vals => {
          const o = {};
          norm.forEach((hdr,i)=>{ if(RUT_HEADERS.includes(hdr)) o[hdr]=vals[i]; });
          return o;
        });
      })();

      const res = await fetch(`/cargar-pedidos?dia=${encodeURIComponent(dia)}`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ pedidos:datosPed, rutas:datosRut })
      });
      if (!res.ok) {
        const err = await res.json().catch(()=>({error:`Error ${res.status}`}));
        throw new Error(err.error);
      }

      const blob = await res.blob();
      const cd   = res.headers.get('Content-Disposition');
      const fn   = cd?.match(/filename="(.+)"/)?.[1] || `Resumen_${Date.now()}.xlsx`;
      const a    = document.createElement('a');
      a.href     = URL.createObjectURL(blob);
      a.download = fn;
      document.body.appendChild(a);
      a.click();
      a.remove();

      showMsg('success','Descarga iniciada.');
      form.reset();
    } catch (err) {
      showMsg('error', err.message);
    } finally {
      overlay.classList.add('hidden');
      btn.disabled = false;
    }
  });
});
</script>
{% endblock %}












