{% extends "base.html" %}
{% block title %}Cargar Pedidos & Rutas{% endblock %}

{% block content %}
<div class="relative">

  <!-- Spinner -->
  <div id="loading-overlay"
       class="hidden absolute inset-0 bg-white bg-opacity-75
              flex items-center justify-center z-50">
    <svg class="h-12 w-12 animate-spin text-blue-600"
         xmlns="http://www.w3.org/2000/svg" fill="none"
         viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10"
              stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor"
            d="M4 12a8 8 0 018-8v4l3-3-3-3v4a8 8 0 100 16v-4l-3 3 3 3v-4a8 8 0 01-8-8z">
      </path>
    </svg>
  </div>

  <!-- Contenedor principal -->
  <div class="max-w-lg mx-auto bg-white p-8 rounded-3xl shadow-xl space-y-6">

    <!-- TÃ­tulo -->
    <h1 class="text-3xl font-extrabold text-center">ðŸ“¤ Cargar Pedidos & Rutas</h1>

    <!-- Instrucciones -->
    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 space-y-3 rounded-lg">
      <h2 class="font-semibold text-blue-700">ðŸ“¥ Cargar aquÃ­ los archivos:</h2>
      <!-- ... (instrucciones iguales) ... -->
    </div>

    <!-- Flash messages -->
    <div id="flash-messages" class="space-y-2"></div>

    <!-- Formulario de carga -->
    <form id="upload-form" class="space-y-4">
      <!-- ... (inputs de archivos y select) ... -->
      <button id="submit-btn" type="submit"
              class="w-full py-3 font-semibold rounded-xl
                     bg-blue-600 text-white hover:bg-blue-700 transition">
        Cargar Masivo
      </button>
    </form>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const form         = document.getElementById('upload-form');
  const overlay      = document.getElementById('loading-overlay');
  const flashContainer = document.getElementById('flash-messages');
  const submitBtn    = document.getElementById('submit-btn');
  const inputPedidos = document.getElementById('file-pedidos');
  const inputRutas   = document.getElementById('file-rutas');
  const selectDia    = document.getElementById('select-dia');

  // mismas constantes de mapeo y validaciÃ³n...

  function mostrarMensaje(tipo, mensajes) {
    flashContainer.innerHTML = '';
    const div = document.createElement('div');
    div.className = 'px-4 py-2 rounded-lg ' +
      (tipo === 'success'
        ? 'bg-green-100 text-green-700'
        : 'bg-red-100 text-red-700');
    if (Array.isArray(mensajes)) {
      const ul = document.createElement('ul');
      mensajes.forEach(msg => {
        const li = document.createElement('li');
        li.textContent = msg;
        ul.appendChild(li);
      });
      div.appendChild(ul);
    } else {
      div.textContent = mensajes;
    }
    flashContainer.appendChild(div);
  }

  // funciones leerEncabezados y leerDatosFiltrados (igual que antes)...

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    flashContainer.innerHTML = '';
    overlay.classList.remove('hidden');
    submitBtn.disabled = true;

    // validaciones de archivos y dÃ­a...

    try {
      // validaciÃ³n de encabezados (primera fila)...

      // lectura filtrada de datos...

      // procesamiento (fills, tipos)...

      // envÃ­o al backend y descarga inline:
      const payload = { pedidos: datosPed, rutas: datosRut };
      const res = await fetch(`/cargar-pedidos?dia=${encodeURIComponent(selectDia.value)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const errorText = await res.text();
        throw new Error(errorText || `Error ${res.status}`);
      }

      // recibe blob y dispara descarga sin cambiar ventana
      const blob = await res.blob();
      const fname = res.headers.get('Content-Disposition')
                      ?.match(/filename="(.+)"/)?.[1]
                    || `ResumenPedidos_${new Date().toISOString()}.xlsx`;
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fname;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      mostrarMensaje('success', 'Descarga iniciada correctamente.');
      form.reset();
    } catch (err) {
      mostrarMensaje('error', err.message);
    } finally {
      overlay.classList.add('hidden');
      submitBtn.disabled = false;
    }
  });
});
</script>
{% endblock %}









