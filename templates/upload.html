{% extends "base.html" %}
{% block title %}Cargar Pedidos & Rutas{% endblock %}

{% block content %}
<div class="relative">

  <!-- Spinner overlay -->
  <div id="loading-overlay" class="hidden absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
    <svg class="h-12 w-12 animate-spin text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor"
            d="M4 12a8 8 0 018-8v4l3-3-3-3v4a8 8 0 100 16v-4l-3 3 3 3v-4a8 8 0 01-8-8z"/>
    </svg>
  </div>

  <div class="max-w-lg mx-auto bg-white p-8 rounded-3xl shadow-xl space-y-6">
    <h1 class="text-3xl font-extrabold text-center">📤 Cargar Pedidos & Rutas</h1>

    <!-- instrucciones -->
    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 space-y-3 rounded-lg">
      <h2 class="font-semibold text-blue-700">📥 Cargar aquí los archivos:</h2>
      <div>
        <h3 class="flex items-center text-lg font-medium">
          <span class="mr-2 text-green-600">✅</span>
          <span class="underline">ECOM</span>
        </h3>
        <ol class="list-decimal list-inside text-gray-700 ml-6">
          <li>Comercial → Pedidos → Todos los pedidos en estado «Sin Descargar»</li>
          <li>Despachos → ClixRuta</li>
        </ol>
      </div>
      <div>
        <h3 class="flex items-center text-lg font-medium">
          <span class="mr-2 text-purple-600">📦</span>
          <span class="underline">CELUWEB</span>
        </h3>
        <ol class="list-decimal list-inside text-gray-700 ml-6">
          <li>Informes → Pedidos → Informe de pedidos por material</li>
          <li>Logística → Facturación → Administración de Rutas → Asignación de Rutas → Exportar Rutas Asignadas</li>
        </ol>
      </div>
      <p class="text-red-600 font-semibold">
        ⚠️ <span class="font-medium">IMPORTANTE:</span> Antes de generar los pedidos, todos los clientes deben tener una ruta asignada.
      </p>
    </div>

    <div id="flash-messages" class="space-y-2"></div>

    <form id="upload-form" class="space-y-4">
      <div>
        <label class="block mb-1 font-medium">📄 Excel Pedidos</label>
        <input type="file" id="file-pedidos" accept=".xlsx" required
               class="block w-full text-sm text-gray-600
                      file:py-2 file:px-4 file:border-0 file:rounded-xl
                      file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
      </div>
      <div>
        <label class="block mb-1 font-medium">🚚 Excel Rutas</label>
        <input type="file" id="file-rutas" accept=".xlsx" required
               class="block w-full text-sm text-gray-600
                      file:py-2 file:px-4 file:border-0 file:rounded-xl
                      file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
      </div>
      <div>
        <label class="block mb-1 font-medium">📆 Día de la semana</label>
        <select id="select-dia" required
                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
          <option value="" disabled selected>Selecciona un día</option>
          <option value="LU">Lunes (LU)</option>
          <option value="MA">Martes (MA)</option>
          <option value="MI">Miércoles (MI)</option>
          <option value="JU">Jueves (JU)</option>
          <option value="VI">Viernes (VI)</option>
          <option value="SA">Sábado (SA)</option>
          <option value="DO">Domingo (DO)</option>
        </select>
      </div>
      <button id="submit-btn" type="submit"
              class="w-full py-3 font-semibold rounded-xl bg-blue-600 text-white hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
              disabled>
        Cargar Masivo
      </button>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Función para sanitizar caracteres en la columna "nombre"
    function sanitizeString(input) {
      if (input == null) return '';
      let text = String(input).trim();
      try { text = decodeURIComponent(escape(text)); } catch {};
      return text.normalize('NFC');
    }

    const fPed    = document.getElementById('file-pedidos');
    const fRut    = document.getElementById('file-rutas');
    const selDia  = document.getElementById('select-dia');
    const btn     = document.getElementById('submit-btn');
    const overlay = document.getElementById('loading-overlay');
    const flash   = document.getElementById('flash-messages');
    const form    = document.getElementById('upload-form');

    const PED_HEADERS = ["numero_pedido","cliente","nombre","barrio","ciudad","asesor","codigo_pro","producto","cantidad","valor","tipo_pro","estado"];
    const RUT_HEADERS = ["codigo_cliente","codigo_ruta"];
    const DIAS_VALIDOS = ["LU","MA","MI","JU","VI","SA","DO"];

    const PED_COL_MAP = {
      'pedido':'numero_pedido','cliente':'cliente','código cliente':'cliente',
      'r. social':'nombre','razón social':'nombre','barrio':'barrio','ciudad':'ciudad',
      'asesor':'asesor','código vendedor':'asesor','cod.prod':'codigo_pro',
      'código producto':'codigo_pro','producto':'producto','cantidad':'cantidad',
      'valor':'valor','total':'valor','venta neta iva':'valor',
      'tip pro':'tipo_pro','tipo_prod':'tipo_pro','estado':'estado','est':'estado'
    };
    const RUT_COL_MAP = {
      'cod. cliente':'codigo_cliente','código cw':'codigo_cliente',
      'ruta':'codigo_ruta','descripción ruta':'codigo_ruta'
    };

    let wbPed, wbRut;
    async function loadWorkbooks() {
      if (!fPed.files[0] || !fRut.files[0]) return;
      const bufPed = await fPed.files[0].arrayBuffer();
      const bufRut = await fRut.files[0].arrayBuffer();
      wbPed = XLSX.read(bufPed, { type:'array' });
      wbRut = XLSX.read(bufRut, { type:'array' });
    }

    async function reactiveValidate() {
      flash.innerHTML = '';
      btn.disabled = true;
      if (!fPed.files[0] || !fRut.files[0]) return;

      const rawPed = XLSX.utils.sheet_to_json(wbPed.Sheets[wbPed.SheetNames[0]], { header:1, sheetRows:1, defval:'' })[0]
        .map(h => String(h).trim().toLowerCase());
      const rawRut = XLSX.utils.sheet_to_json(wbRut.Sheets[wbRut.SheetNames[0]], { header:1, sheetRows:1, defval:'' })[0]
        .map(h => String(h).trim().toLowerCase());

      let normPed = rawPed.map(h => PED_COL_MAP[h] || h).filter(hdr => hdr !== '');
      let normRut = rawRut.map(h => RUT_COL_MAP[h] || h).filter(hdr => hdr !== '');
      if (!normPed.includes('tipo_pro')) normPed.push('tipo_pro');

      const headerKey = 'valor';
      while (true) {
        const firstIdx = normPed.indexOf(headerKey);
        const lastIdx  = normPed.lastIndexOf(headerKey);
        if (firstIdx === -1 || firstIdx === lastIdx) break;
        normPed.splice(firstIdx, 1);
      }

      function check(rawNorm, expected) {
        const seen = new Set(), dup = [], falt = [];
        rawNorm.forEach(h => { if (seen.has(h)) dup.push(h); seen.add(h); });
        expected.forEach(e => { if (!seen.has(e)) falt.push(e); });
        return { dup: [...new Set(dup)], falt };
      }

      const vPed = check(normPed, PED_HEADERS);
      const vRut = check(normRut, RUT_HEADERS);
      const errors = [];
      if (vPed.dup.length) errors.push('Duplicadas en pedidos: ' + vPed.dup.join(', '));
      if (vPed.falt.length) errors.push('Faltan en pedidos: ' + vPed.falt.join(', '));
      if (vRut.dup.length) errors.push('Duplicadas en rutas: ' + vRut.dup.join(', '));
      if (vRut.falt.length) errors.push('Faltan en rutas: ' + vRut.falt.join(', '));
      if (errors.length) showMsg('error', errors);
      else { showMsg('success','Listo para cargar'); btn.disabled = false; }
    }

    fPed.addEventListener('change', async () => { await loadWorkbooks(); reactiveValidate(); });
    fRut.addEventListener('change', async () => { await loadWorkbooks(); reactiveValidate(); });

    form.addEventListener('submit', async e => {
      e.preventDefault(); flash.innerHTML = ''; overlay.classList.remove('hidden'); btn.disabled = true;
      const dia = selDia.value;
      if (!DIAS_VALIDOS.includes(dia)) { showMsg('error',['Día inválido.']); overlay.classList.add('hidden'); btn.disabled=false; return; }
      try {
        const sheetPed = wbPed.Sheets[wbPed.SheetNames[0]];
        const rowsPed = XLSX.utils.sheet_to_json(sheetPed, { header:1, defval:null });
        const rawHead = rowsPed[0].map(h => String(h).trim().toLowerCase());
        const normHead = rawHead.map(h => PED_COL_MAP[h]||h);
        if (!normHead.includes('tipo_pro')) normHead.push('tipo_pro');

        let data = rowsPed.slice(1).map(vals => {
          const o = {};
          normHead.forEach((hdr,i) => {
            if (PED_HEADERS.includes(hdr)) {
              let value = vals[i];
              if (hdr === 'nombre') value = sanitizeString(value);
              o[hdr] = (hdr==='tipo_pro' && rawHead.indexOf('tipo_pro')<0) ? 'N' : value;
            }
          });
          return o;
        });

        if (data.some(r => !r.nombre)) {
          const grupos = {};
          data.forEach((r,i) => (grupos[r.cliente] = grupos[r.cliente] || []).push({ i, r }));
          Object.values(grupos).forEach(arr => { arr.sort((a,b) => a.i-b.i); /* lógica existente */ });
        }
        data = data.filter(r => ['Sin Descargar','Sin facturar'].includes(r.estado));
        // Procesar rutas y descarga...
      } catch(err) {
        showMsg('error', err.message);
      } finally { overlay.classList.add('hidden'); btn.disabled = false; }
    });
  });
</script>
{% endblock %}















