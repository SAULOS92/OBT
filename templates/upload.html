{% extends "base.html" %}
{% block title %}Cargar Pedidos & Rutas{% endblock %}

{% block content %}
<div class="relative">

  <!-- Spinner -->
  <div id="loading-overlay"
       class="hidden absolute inset-0 bg-white bg-opacity-75
              flex items-center justify-center z-50">
    <svg class="h-12 w-12 animate-spin text-blue-600"
         xmlns="http://www.w3.org/2000/svg" fill="none"
         viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10"
              stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor"
            d="M4 12a8 8 0 018-8v4l3-3-3-3v4a8 8 0 100 16v-4l-3 3 3 3v-4a8 8 0 01-8-8z">
      </path>
    </svg>
  </div>

  <!-- Contenedor principal -->
  <div class="max-w-lg mx-auto bg-white p-8 rounded-3xl shadow-xl space-y-6">

    <!-- Título -->
    <h1 class="text-3xl font-extrabold text-center">📤 Cargar Pedidos & Rutas</h1>

    <!-- Instrucciones -->
    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 space-y-3 rounded-lg">
      <h2 class="font-semibold text-blue-700">📥 Cargar aquí los archivos:</h2>

      <div>
        <h3 class="flex items-center text-lg font-medium">
          <span class="mr-2 text-green-600">✅</span> <span class="underline">ECOM</span>
        </h3>
        <ol class="list-decimal list-inside text-gray-700 space-y-1 ml-6">
          <li>Comercial → Pedidos → Todos los pedidos en estado «Sin Descargar»</li>
          <li>Despachos → ClixRuta</li>
        </ol>
      </div>

      <div>
        <h3 class="flex items-center text-lg font-medium">
          <span class="mr-2 text-purple-600">📦</span> <span class="underline">CELUWEB</span>
        </h3>
        <ol class="list-decimal list-inside text-gray-700 space-y-1 ml-6">
          <li>Pedidos</li>
          <li>Logística → Facturación → Administración de Rutas → Asignación de Rutas → Exportar Rutas Asignadas</li>
        </ol>
      </div>

      <p class="mt-2 text-red-600 font-semibold">
        ⚠️ <span class="font-medium">IMPORTANTE:</span> Antes de generar los pedidos, todos los clientes deben tener una ruta asignada.
      </p>
    </div>

    <!-- Flash messages -->
    <div id="flash-messages" class="space-y-2">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for cat, msg in messages %}
            <div class="px-4 py-2 rounded-lg
                        {% if cat=='success' %}bg-green-100 text-green-700{% else %}bg-red-100 text-red-700{% endif %}">
              {{ msg }}
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
    </div>

    <!-- Formulario de carga -->
    <form id="upload-form"
          method="POST"
          enctype="multipart/form-data"
          class="space-y-4">
      <div>
        <label class="block mb-1 font-medium">📄 Excel Pedidos</label>
        <input type="file" name="pedidos" id="file-pedidos" accept=".xlsx"
               class="block w-full text-sm text-gray-600
                      file:py-2 file:px-4 file:border-0
                      file:rounded-xl file:bg-blue-50 file:text-blue-700
                      hover:file:bg-blue-100"
               required>
      </div>
      <div>
        <label class="block mb-1 font-medium">🚚 Excel Rutas</label>
        <input type="file" name="rutas" id="file-rutas" accept=".xlsx"
               class="block w-full text-sm text-gray-600
                      file:py-2 file:px-4 file:border-0
                      file:rounded-xl file:bg-blue-50 file:text-blue-700
                      hover:file:bg-blue-100"
               required>
      </div>
      <div>
        <label class="block mb-1 font-medium">📆 Día de la semana</label>
        <select name="dia" id="select-dia" required
                class="w-full px-4 py-2 border rounded-lg
                       focus:outline-none focus:ring-2 focus:ring-blue-400">
          <option value="" disabled selected>Selecciona un día</option>
          <option value="LU">Lunes (LU)</option>
          <option value="MA">Martes (MA)</option>
          <option value="MI">Miércoles (MI)</option>
          <option value="JU">Jueves (JU)</option>
          <option value="VI">Viernes (VI)</option>
          <option value="SA">Sábado (SA)</option>
          <option value="DO">Domingo (DO)</option>
        </select>
      </div>
      <button type="submit"
              class="w-full py-3 font-semibold rounded-xl
                     bg-blue-600 text-white hover:bg-blue-700 transition">
        Cargar Masivo
      </button>
    </form>

    <!-- Botón de descarga tras éxito -->
    {% if mostrar_descarga %}
      <div class="mt-4 text-center">
        <a href="{{ url_for('upload.descargar_resumen') }}"
           class="inline-block px-6 py-3 bg-green-600 text-white font-semibold rounded-xl
                  hover:bg-green-700 transition">
          Descargar Resumen
        </a>
      </div>
    {% endif %}
  </div>
</div>

<!-- SheetJS para leer Excel en el navegador -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form           = document.getElementById('upload-form');
  const overlay        = document.getElementById('loading-overlay');
  const inputPedidos   = document.getElementById('file-pedidos');
  const inputRutas     = document.getElementById('file-rutas');
  const selectDia      = document.getElementById('select-dia');
  const flashContainer = document.getElementById('flash-messages');

  const PED_HEADERS = [
    'numero_pedido','cliente','nombre','barrio','ciudad',
    'asesor','codigo_pro','producto','cantidad','valor',
    'tipo_pro','estado'
  ];
  const RUT_HEADERS = ['codigo_cliente','codigo_ruta'];
  const DIAS_VALIDOS = ['LU','MA','MI','JU','VI','SA','DO'];

  // Mapas de sinónimos reales invertidos:
  const PED_COL_MAP = {
    'pedido': 'numero_pedido',
    'cliente': 'cliente',
    'código cliente': 'cliente',
    'r. social': 'nombre',
    'razón social': 'nombre',
    'barrio': 'barrio',
    'barrio': 'barrio',
    'ciudad': 'ciudad',
    'ciudad': 'ciudad',
    'asesor': 'asesor',
    'código vendedor': 'asesor',
    'cod.prod': 'codigo_pro',
    'código producto': 'codigo_pro',
    'producto': 'producto',
    'cantidad': 'cantidad',
    'valor': 'valor',
    'total': 'valor',
    'venta neta iva': 'valor',
    'tip pro': 'tipo_pro',
    'estado': 'estado',
    'est': 'estado'
  };
  const RUT_COL_MAP = {
    'cod. cliente': 'codigo_cliente',
    'código cw': 'codigo_cliente',
    'ruta': 'codigo_ruta',
    'descripción ruta': 'codigo_ruta'
  };

  function mostrarMensaje(tipo, mensajes) {
    flashContainer.innerHTML = '';
    const div = document.createElement('div');
    div.className = 'px-4 py-2 rounded-lg ' +
      (tipo === 'success'
        ? 'bg-green-100 text-green-700'
        : 'bg-red-100 text-red-700');
    if (Array.isArray(mensajes)) {
      const ul = document.createElement('ul');
      mensajes.forEach(msg => {
        const li = document.createElement('li');
        li.textContent = msg;
        ul.appendChild(li);
      });
      div.appendChild(ul);
    } else {
      div.textContent = mensajes;
    }
    flashContainer.appendChild(div);
  }

  async function leerExcel(file) {
    const buffer = await file.arrayBuffer();
    const wb = XLSX.read(buffer, { type: 'array' });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    return XLSX.utils.sheet_to_json(sheet, { defval: null });
  }

  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    flashContainer.innerHTML = '';
    overlay.classList.remove('hidden');

    const filePed = inputPedidos.files[0];
    const fileRut = inputRutas.files[0];
    const dia     = selectDia.value;
    let errores   = [];

    // Validación inicial
    if (!filePed || !fileRut) {
      errores.push('Debe seleccionar ambos archivos (pedidos y rutas).');
    } else {
      const extOk = f => /\.(xlsx|xls)$/i.test(f.name);
      if (!extOk(filePed)) errores.push('El archivo de pedidos no es un Excel válido.');
      if (!extOk(fileRut)) errores.push('El archivo de rutas no es un Excel válido.');
    }
    if (!dia || !DIAS_VALIDOS.includes(dia)) {
      errores.push('El día seleccionado no es válido.');
    }
    if (errores.length) {
      overlay.classList.add('hidden');
      mostrarMensaje('error', errores);
      return;
    }

    try {
      // Leer archivos
      const [rawPed, rawRut] = await Promise.all([
        leerExcel(filePed),
        leerExcel(fileRut)
      ]);

      // Extraer encabezados originales
      const encPed = rawPed.length ? Object.keys(rawPed[0]) : [];
      const encRut = rawRut.length ? Object.keys(rawRut[0]) : [];

      // Normalizar encabezados
      const normPed = encPed.map(h => {
        const clave = h.toString().trim().toLowerCase();
        return PED_COL_MAP[clave] || clave;
      });
      const normRut = encRut.map(h => {
        const clave = h.toString().trim().toLowerCase();
        return RUT_COL_MAP[clave] || clave;
      });

      // Validar faltantes y duplicados
      errores = [];
      PED_HEADERS.forEach(r => {
        if (!normPed.includes(r)) errores.push(`Falta columna obligatoria en pedidos: "${r}"`);
      });
      RUT_HEADERS.forEach(r => {
        if (!normRut.includes(r)) errores.push(`Falta columna obligatoria en rutas: "${r}"`);
      });
      normPed.filter((c,i) => normPed.indexOf(c)!==i)
             .forEach(c => errores.push(`Columna duplicada en pedidos: "${c}"`));
      normRut.filter((c,i) => normRut.indexOf(c)!==i)
             .forEach(c => errores.push(`Columna duplicada en rutas: "${c}"`));
      if (errores.length) {
        overlay.classList.add('hidden');
        mostrarMensaje('error', errores);
        return;
      }

      // Mapear datos a objetos canónicos
      const datosPed = rawPed.map(row => {
        const o = {};
        encPed.forEach((orig,i) => {
          const n = normPed[i];
          if (PED_HEADERS.includes(n)) o[n] = row[orig];
        });
        return o;
      });
      const datosRut = rawRut.map(row => {
        const o = {};
        encRut.forEach((orig,i) => {
          const n = normRut[i];
          if (RUT_HEADERS.includes(n)) o[n] = row[orig];
        });
        return o;
      });

      // Forward/backward fill por cliente en pedidos
      const grupos = {};
      datosPed.forEach((f,i) => {
        (grupos[f.cliente] = grupos[f.cliente]||[]).push({i,f});
      });
      Object.values(grupos).forEach(arr => {
        arr.sort((a,b)=>a.i-b.i);
        let ln, lb, lc;
        arr.forEach(x => {
          const f = x.f;
          if (f.nombre) ln = f.nombre; else if (ln) f.nombre = ln;
          if (f.barrio) lb = f.barrio; else if (lb) f.barrio = lb;
          if (f.ciudad) lc = f.ciudad; else if (lc) f.ciudad = lc;
        });
        let nn, nb, nc;
        arr.slice().reverse().forEach(x => {
          const f = x.f;
          if (f.nombre) nn = f.nombre; else if (nn) f.nombre = nn;
          if (f.barrio) nb = f.barrio; else if (nb) f.barrio = nb;
          if (f.ciudad) nc = f.ciudad; else if (nc) f.ciudad = nc;
        });
      });

      // Conversión de tipos y default tipo_pro
      datosPed.forEach(f => {
        const ci = parseInt(f.cantidad); f.cantidad = isNaN(ci)?0:ci;
        const vf = parseFloat(f.valor);  f.valor    = isNaN(vf)?0.0:vf;
        if (!f.tipo_pro) f.tipo_pro = 'N';
      });

      // Enviar DOS JSON (pedidos, rutas) y el día
      const payload = { pedidos: datosPed, rutas: datosRut };
      const res = await fetch(`/cargar-pedidos?dia=${encodeURIComponent(dia)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        let msg = `Error ${res.status}`;
        try { msg = (await res.json()).error || msg; } catch {}
        throw new Error(msg);
      }
      const data = await res.json().catch(()=>({}));
      overlay.classList.add('hidden');
      mostrarMensaje('success', data.message || 'Carga masiva completada exitosamente.');
      form.reset();

    } catch (err) {
      overlay.classList.add('hidden');
      mostrarMensaje('error', err.message || 'Error inesperado procesando los archivos.');
    }
  });
});
</script>
{% endblock %}







